name: Build and Publish (All Formats)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # --- 1. WINDOWS (MSI Installer + Portable ZIP) ---
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v3

      # Собираем и MSI, и папку с EXE (image)
      - name: Build Windows Targets
        run: ./gradlew.bat :client-ui:packageMsi :client-ui:packageDistribution

      - name: Prepare Artifacts
        shell: pwsh
        run: |
          # 1. Переименовываем MSI
          Get-ChildItem client-ui/build/compose/binaries/main/msi/*.msi | Rename-Item -NewName "AuraLauncher-Setup.msi"
          Move-Item client-ui/build/compose/binaries/main/msi/AuraLauncher-Setup.msi .

          # 2. Создаем Portable ZIP (из папки app)
          # ИМЯ ИЗМЕНЕНО НА: AuraLauncher-Win-Portable.zip
          Compress-Archive -Path client-ui/build/compose/binaries/main/app/* -DestinationPath AuraLauncher-Win-Portable.zip

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-files
          path: |
            AuraLauncher-Setup.msi
            AuraLauncher-Win-Portable.zip
          if-no-files-found: error

  # --- 2. LINUX (AppImage, Deb, Rpm) ---
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v3
      - run: chmod +x gradlew

      # ФИКС: Добавлен libfuse2 (критично для AppImage!) и file (для проверки)
      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y libgl1 libgl1-mesa-dri xorg-dev rpm binutils libfuse2 file

      - name: Setup AppImageTool
        run: |
          # Скачиваем тулзу
          wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool.AppImage
          chmod +x appimagetool.AppImage
          # Распаковываем
          ./appimagetool.AppImage --appimage-extract

      - name: Build Linux Targets
        run: ./gradlew :client-ui:packageAppImage :client-ui:packageDeb :client-ui:packageRpm

      - name: Prepare Artifacts
        shell: bash
        run: |
          # 1. Готовим структуру AppDir
          mkdir -p AppDir/usr
          cp -r client-ui/build/compose/binaries/main/app/* AppDir/usr/
          
          # 2. Создаем AppRun (скрипт запуска)
          cat > AppDir/AppRun <<EOF
          #!/bin/sh
          export APPDIR="\$(dirname "\$(readlink -f "\${0}")")"
          export PATH="\$APPDIR/usr/bin:\$PATH"
          export LD_LIBRARY_PATH="\$APPDIR/usr/lib:\$LD_LIBRARY_PATH"
          exec "\$APPDIR/usr/bin/AuraLauncher" "\$@"
          EOF
          chmod +x AppDir/AppRun
          chmod +x AppDir/usr/bin/AuraLauncher
          
          # 3. .desktop файл
          cat > AppDir/AuraLauncher.desktop <<EOF
          [Desktop Entry]
          Name=Aura Launcher
          Exec=AuraLauncher
          Icon=AuraLauncher
          Type=Application
          Categories=Game;
          EOF
          
          # 4. Иконка
          cp client-ui/src/main/resources/images/favicon.png AppDir/AuraLauncher.png
          
          # 5. Сборка .AppImage
          ARCH=x86_64 ./squashfs-root/AppRun --no-appstream AppDir AuraLauncher.AppImage
          
          # 6. Проверка (Вывод инфо о файле в лог, чтобы убедиться, что он живой)
          echo "Checking generated file:"
          file AuraLauncher.AppImage
          ls -lh AuraLauncher.AppImage
          
          # 7. Deb и Rpm
          find client-ui/build/compose/binaries -name "*.deb" -exec mv {} AuraLauncher.deb \;
          find client-ui/build/compose/binaries -name "*.rpm" -exec mv {} AuraLauncher.rpm \;

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-files
          path: |
            AuraLauncher.AppImage
            AuraLauncher.deb
            AuraLauncher.rpm
          if-no-files-found: error

  # --- 3. MACOS (DMG) ---
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v3
      - run: chmod +x gradlew

      - name: Build DMG
        run: ./gradlew :client-ui:packageDmg

      - name: Prepare Artifact
        shell: bash
        run: |
          find client-ui/build/compose/binaries -name "*.dmg" -exec mv {} AuraLauncher.dmg \;

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-file
          path: AuraLauncher.dmg
          if-no-files-found: error

  # --- 4. CREATE RELEASE ---
  publish-release:
    name: Publish Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List Files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          files: |
            artifacts/AuraLauncher-Setup.msi
            artifacts/AuraLauncher-Win-Portable.zip
            artifacts/AuraLauncher.AppImage
            artifacts/AuraLauncher.deb
            artifacts/AuraLauncher.rpm
            artifacts/AuraLauncher.dmg