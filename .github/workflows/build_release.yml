name: Build and Package Launcher

on:
  workflow_dispatch: # Возможность запустить кнопку вручную
  push:
    tags:
      - 'v*' # Запускать автоматически при создании тега (например, v1.0.0)

jobs:
  # --- СБОРКА ДЛЯ WINDOWS ---
  build-windows:
    name: Build Windows (MSI)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build MSI Package
        run: ./gradlew.bat :client-ui:packageMsi

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: client-ui/build/compose/binaries/main/msi/*.msi
          if-no-files-found: error

  # --- СБОРКА ДЛЯ LINUX ---
  build-linux:
    name: Build Linux (AppImage & Deb)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Для Linux часто нужны библиотеки для работы Compose при сборке
      - name: Install Linux Dependencies
        run: sudo apt-get update && sudo apt-get install -y libgl1 libgl1-mesa-dri xorg-dev

      - name: Build AppImage and Deb
        run: ./gradlew :client-ui:packageAppImage :client-ui:packageDeb

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: client-ui/build/compose/binaries/main/appImage/*.AppImage

      - name: Upload Linux Deb
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: client-ui/build/compose/binaries/main/deb/*.deb

  # --- СБОРКА ДЛЯ MACOS ---
  build-macos:
    name: Build macOS (DMG)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build DMG Package
        run: ./gradlew :client-ui:packageDmg
        # Обратите внимание: без Apple Developer ID приложение будет "неподписанным"
        # и пользователям придется разрешать его запуск через настройки.

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: client-ui/build/compose/binaries/main/dmg/*.dmg
          if-no-files-found: error
