name: Build and Publish (All Formats)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # --- 1. WINDOWS (MSI Installer + Portable ZIP) ---
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v3

      # Собираем и MSI, и папку с EXE (image)
      - name: Build Windows Targets
        run: ./gradlew.bat :client-ui:packageMsi :client-ui:packageDistribution

      - name: Prepare Artifacts
        shell: pwsh
        run: |
          # 1. Переименовываем MSI
          Get-ChildItem client-ui/build/compose/binaries/main/msi/*.msi | Rename-Item -NewName "AuraLauncher-Setup.msi"
          Move-Item client-ui/build/compose/binaries/main/msi/AuraLauncher-Setup.msi .

          # 2. Создаем Portable ZIP (из папки app)
          # Это даст пользователям .exe без установки
          Compress-Archive -Path client-ui/build/compose/binaries/main/app/* -DestinationPath AuraLauncher-Portable.zip

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-files
          path: |
            AuraLauncher-Setup.msi
            AuraLauncher-Portable.zip
          if-no-files-found: error

  # --- 2. LINUX (AppImage, Deb, Rpm) ---
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v3
      - run: chmod +x gradlew

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y libgl1 libgl1-mesa-dri xorg-dev rpm binutils

      - name: Setup AppImageTool
        run: |
          wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool.AppImage
          chmod +x appimagetool.AppImage
          # Распаковываем тулзу, чтобы не зависеть от FUSE на агенте
          ./appimagetool.AppImage --appimage-extract

      - name: Build Linux Targets
        run: ./gradlew :client-ui:packageAppImage :client-ui:packageDeb :client-ui:packageRpm

      - name: Prepare Artifacts
        shell: bash
        run: |
          # 1. Готовим правильную структуру AppDir
          mkdir -p AppDir/usr
          # Копируем всё, что собрал Gradle (bin, lib, runtime) в usr/
          cp -r client-ui/build/compose/binaries/main/app/* AppDir/usr/
          
          # 2. Создаем симлинк для запуска (AppRun)
          # appimagetool запускает файл, на который указывает AppRun
          cd AppDir
          ln -s usr/bin/AuraLauncher AppRun
          cd ..
          
          # 3. Создаем файл .desktop (Обязателен в корне)
          cat > AppDir/AuraLauncher.desktop <<EOF
          [Desktop Entry]
          Name=Aura Launcher
          Exec=AuraLauncher
          Icon=AuraLauncher
          Type=Application
          Categories=Game;
          EOF
          
          # 4. Копируем иконку (Обязательна в корне)
          # Используем favicon.png из исходников
          cp client-ui/src/main/resources/images/favicon.png AppDir/AuraLauncher.png
          
          # 5. Собираем .AppImage (используя распакованный тул)
          ARCH=x86_64 ./squashfs-root/AppRun AppDir AuraLauncher.AppImage
          
          # 6. Подбираем Deb и Rpm
          find client-ui/build/compose/binaries -name "*.deb" -exec mv {} AuraLauncher.deb \;
          find client-ui/build/compose/binaries -name "*.rpm" -exec mv {} AuraLauncher.rpm \;

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-files
          path: |
            AuraLauncher.AppImage
            AuraLauncher.deb
            AuraLauncher.rpm
          if-no-files-found: error

  # --- 3. MACOS (DMG) ---
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v3
      - run: chmod +x gradlew

      - name: Build DMG
        run: ./gradlew :client-ui:packageDmg

      - name: Prepare Artifact
        shell: bash
        run: |
          find client-ui/build/compose/binaries -name "*.dmg" -exec mv {} AuraLauncher.dmg \;

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-file
          path: AuraLauncher.dmg
          if-no-files-found: error

  # --- 4. CREATE RELEASE ---
  publish-release:
    name: Publish Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List Files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          files: |
            artifacts/AuraLauncher-Setup.msi
            artifacts/AuraLauncher-Portable.zip
            artifacts/AuraLauncher.AppImage
            artifacts/AuraLauncher.deb
            artifacts/AuraLauncher.rpm
            artifacts/AuraLauncher.dmg